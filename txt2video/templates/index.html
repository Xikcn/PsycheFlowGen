<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>短视频分镜视频生成器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .header h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            color: #7f8c8d;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .section-title {
            font-size: 1.5rem;
            color: #3498db;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
            display: flex;
            align-items: center;
        }

        .section-title i {
            margin-right: 10px;
        }

        .config-section {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }

        .config-card {
            flex: 1;
            min-width: 300px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid #eee;
        }

        .config-card h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            display: flex;
            align-items: center;
        }

        .config-card h3 i {
            margin-right: 10px;
            color: #3498db;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group input[type="file"] {
            display: none;
        }

        .upload-area {
            padding: 20px;
            border: 2px dashed #3498db;
            border-radius: 5px;
            text-align: center;
            background-color: #e8f4fe;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .upload-area:hover {
            background-color: #d1e8ff;
            border-color: #2980b9;
        }

        .upload-area i {
            font-size: 2rem;
            color: #3498db;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .preview-image {
            max-width: 100%;
            max-height: 200px;
            margin-top: 15px;
            display: none;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        select, input[type="range"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            font-family: inherit;
            font-size: 1rem;
        }

        input[type="range"] {
            padding: 0;
        }

        .range-value {
            display: inline-block;
            min-width: 30px;
            text-align: center;
            font-weight: bold;
        }

        .scene-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }

        .scene-card {
            flex: 1 1 calc(50% - 20px);
            min-width: 300px;
            background: white;
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .scene-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.12);
            border-color: #3498db;
        }

        .scene-card.drag-over {
            background-color: #e8f4fe;
            border: 2px dashed #3498db;
        }

        .scene-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .scene-header:hover {
            background: linear-gradient(135deg, #2980b9, #1f5f8b);
        }

        .scene-header.collapsed {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }

        .scene-number {
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .scene-number i {
            transition: transform 0.3s ease;
        }

        .scene-header.collapsed .scene-number i {
            transform: rotate(-90deg);
        }

        .scene-duration {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
        }

        .scene-content {
            padding: 20px;
            display: block;
            transition: all 0.3s ease;
        }

        .scene-content.collapsed {
            display: none;
        }

        .prompt-list {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
            position: relative;
            border: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .prompt-text {
            flex: 1;
            font-size: 0.9rem;
            color: #555;
            margin-right: 10px;
        }

        .copy-btn {
            padding: 6px 12px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        .copy-btn:hover {
            background: linear-gradient(135deg, #2980b9, #1f5f8b);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }

        .copy-btn:active {
            transform: translateY(0);
        }

        .copy-btn i {
            font-size: 0.8rem;
        }

        .split-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .split-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .split-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f8f9fa;
        }

        .split-item-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .split-item-content {
            margin-bottom: 15px;
        }

        .split-item-content textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
            background: #f8f9fa;
            transition: border-color 0.3s ease;
        }

        .split-item-content textarea:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .split-item-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .split-item-actions .copy-btn {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .content-splitter {
            background: linear-gradient(135deg, #e8f6ff, #d1e8ff);
            border: 1px solid #cceeff;
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.1);
        }

        .content-splitter h4 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .splitter-settings {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .splitter-settings .form-group {
            flex: 1;
            min-width: 200px;
            margin-bottom: 0;
        }

        #article-content {
            min-height: 150px;
            background-color: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            font-size: 1rem;
            line-height: 1.6;
            transition: border-color 0.3s ease;
        }

        #article-content:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .split-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .split-btn:hover {
            background: linear-gradient(135deg, #2980b9, #1f5f8b);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .split-btn:active {
            transform: translateY(0);
        }

        .split-results {
            margin-top: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #f0f8ff, #e6f3ff);
            border: 1px solid #d9edf7;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .split-results h5 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .subtitle-section {
            margin-bottom: 15px;
        }

        .subtitle-section strong {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
        }

        .subtitle-section textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            resize: vertical;
            min-height: 80px;
            font-size: 0.95rem;
            line-height: 1.5;
            transition: border-color 0.3s ease;
        }

        .subtitle-section textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .voice-settings {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .voice-setting {
            flex: 1;
            min-width: 200px;
        }

        .voice-setting label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 500;
        }

        .voice-setting select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            background-color: white;
            font-size: 0.95rem;
            color: #495057;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .voice-setting select:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
            outline: none;
        }

        .voice-preview-btn {
            margin-top: 8px;
            padding: 6px 12px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .voice-preview-btn:hover {
            background: linear-gradient(135deg, #2980b9, #1f5f8b);
            transform: translateY(-1px);
        }

        .voice-preview-btn.playing {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .voice-preview-btn.playing:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
        }

        .range-value {
            display: inline-block;
            min-width: 40px;
            text-align: center;
            font-weight: 500;
            color: #3498db;
            background: #e8f4fe;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 8px;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            outline: none;
            margin: 10px 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #3498db;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: #2980b9;
        }

        .scene-upload-area {
            background: #f8f9fa;
            border: 2px dashed #3498db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin: 15px 0;
        }

        .scene-upload-area:hover {
            background: #e8f4fe;
            border-color: #2980b9;
        }

        .scene-preview {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 8px;
            margin-top: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .splitter-settings label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 500;
        }

        .splitter-settings input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .splitter-settings input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .scene-upload-area {
            background: #f8f9fa;
            border: 2px dashed #3498db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin: 15px 0;
        }

        .scene-upload-area:hover {
            background: #e8f4fe;
            border-color: #2980b9;
        }

        .scene-preview {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 8px;
            margin-top: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .generate-btn {
            display: block;
            margin: 30px auto;
            padding: 15px 40px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .generate-btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .generate-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .error-message {
            color: #e74c3c;
            background-color: #fdeded;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
            display: none;
        }

        .videos-section {
            margin-top: 40px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .video-list {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 15px;
        }

        .video-item {
            flex: 1 1 calc(25% - 20px);
            min-width: 250px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .video-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }

        .video-thumb {
            width: 100%;
            height: 140px;
            background: linear-gradient(135deg, #3498db, #2c3e50);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
        }

        .video-info {
            padding: 15px;
        }

        .video-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
            word-break: break-word;
        }

        .video-actions {
            display: flex;
            gap: 10px;
        }

        .video-actions a {
            flex: 1;
            text-align: center;
            padding: 8px;
            background-color: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .video-actions a:hover {
            background-color: #2980b9;
        }

        .config-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .config-item {
            padding: 10px 15px;
            background-color: #e8f4fe;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .config-item:hover {
            background-color: #d1e8ff;
        }

        .progress-container {
            display: none;
            margin: 20px auto;
            max-width: 600px;
            text-align: center;
        }

        .progress-bar {
            height: 20px;
            background-color: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background-color: #3498db;
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        @media (max-width: 768px) {
            .scene-card, .video-item {
                flex: 1 1 100%;
            }

            .config-section {
                flex-direction: column;
            }

            .config-card {
                min-width: 100%;
            }
        }

        .storyboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .storyboard-controls {
            display: flex;
            gap: 10px;
        }
        .add-scene-btn, .save-config-btn {
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .add-scene-btn:hover, .save-config-btn:hover {
            background: #2980b9;
        }
        .storyboard {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }

        .storyboard .scene-card {
            flex: 1 1 calc(50% - 20px);
            min-width: 300px;
        }

        @media (max-width: 768px) {
            .storyboard .scene-card {
                flex: 1 1 100%;
            }
        }

        .ai-guide {
            margin-top: 20px;
        }

        .step-container {
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .step-header {
            background-color: #f8f9fa;
            padding: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.3s;
        }

        .step-header:hover {
            background-color: #e9ecef;
        }

        .step-header h3 {
            margin: 0;
            font-size: 1.1rem;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-content {
            display: none;
            padding: 20px;
            background-color: white;
        }

        .prompt-section, .example-section, .explanation-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            position: relative;
        }

        .prompt-section h3, .example-section h3, .explanation-section h4 {
            margin-top: 0;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .prompt-textarea, .example-textarea, .explanation-textarea {
            width: 100%;
            min-height: 120px;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            line-height: 1.5;
        }

        .json-merger {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .merge-btn {
            width: 100%;
            padding: 10px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .merge-btn:hover {
            background: #2980b9;
        }

        .merge-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .copy-json-btn, .download-json-btn {
            flex: 1;
            padding: 10px;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .copy-json-btn:hover, .download-json-btn:hover {
            background: #27ae60;
        }

        .merged-json {
            background: white;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }

        .prompt-section .copy-btn,
        .example-section .copy-btn,
        .explanation-section .copy-btn {
            position: static;
            margin-top: 10px;
            width: auto;
            display: inline-flex;
            padding: 8px 16px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            align-items: center;
            gap: 5px;
        }

        .prompt-section .copy-btn:hover,
        .example-section .copy-btn:hover,
        .explanation-section .copy-btn:hover {
            background: linear-gradient(135deg, #2980b9, #1f5f8b);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }

        .combined-section .copy-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: 600;
        }

        .combined-section .copy-btn:hover {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(46, 204, 113, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-video"></i> 短视频分镜视频生成器</h1>
            <p>上传分镜图片并修改字幕后生成视频</p>
        </div>

        <div id="error-container" class="error-message"></div>

  <!-- AI提示词部分 -->
  <div class="section">
    <h2 class="section-title"><i class="fas fa-robot"></i> AI提示词指南</h2>
    
    <div class="ai-guide">
        <div class="step-container">
            <div class="step-header" onclick="toggleStep(1)">
                <h3><i class="fas fa-chevron-right"></i> 第一步：生成讲解文字</h3>
            </div>
            <div class="step-content" id="step1-content">
                <div class="prompt-section">
                    <h3>提示词</h3>
                    <textarea id="step1-prompt" class="prompt-textarea" readonly></textarea>
                    <button class="copy-btn" onclick="copyText('step1-prompt')">复制提示词</button>
                </div>
                <div class="example-section">
                    <h3>示例结果</h3>
                    <textarea id="step1-example" class="example-textarea" readonly></textarea>
                    <button class="copy-btn" onclick="copyText('step1-example')">复制示例</button>
                </div>
                <div class="combined-section">
                    <!-- 组合提示词不需要显示内容，只提供复制按钮 -->
                    <button class="copy-btn" id="copy-step1-combined" onclick="copyCombinedPrompt('step1')">一键复制组合提示词</button>
                </div>
            </div>
        </div>

        <div class="step-container">
            <div class="step-header" onclick="toggleStep(2)">
                <h3><i class="fas fa-chevron-right"></i> 第二步：内容拆分</h3>
            </div>
            <div class="step-content" id="step2-content">
                <div class="explanation-section">
                    <h3>说明：</h3>
                    <textarea id="step2-explanation" class="explanation-textarea" readonly></textarea>
                    <button class="copy-btn" onclick="copyText('step2-explanation')">复制说明</button>
                </div>
                <div class="content-splitter">
                    <h4><i class="fas fa-cut"></i> 内容拆分工具</h4>
                    <div class="splitter-settings">
                        <div class="form-group">
                            <label for="min-length">最小长度：</label>
                            <input type="number" id="min-length" min="100" max="1000" value="200">
                        </div>
                        <div class="form-group">
                            <label for="max-length">最大长度：</label>
                            <input type="number" id="max-length" min="100" max="5000" value="1000">
                        </div>
                        <div class="form-group">
                            <label for="split-delimiters">分割符：</label>
                            <input type="text" id="split-delimiters" value="。！？!?.\n">
                        </div>
                    </div>
                    <textarea id="article-content" placeholder="请在此输入需要拆分的长文章内容..."></textarea>
                    <button class="split-btn" onclick="splitContent()">
                        <i class="fas fa-cut"></i> 拆分内容
                    </button>
                    <div id="split-results"></div>
                </div>
            </div>
        </div>

        <div class="step-container">
            <div class="step-header" onclick="toggleStep(3)">
                <h3><i class="fas fa-chevron-right"></i> 第三步：生成分镜脚本</h3>
            </div>
            <div class="step-content" id="step3-content">
                <div class="prompt-section">
                    <h3>提示词</h3>
                    <textarea id="step3-prompt" class="prompt-textarea" readonly></textarea>
                    <button class="copy-btn" onclick="copyText('step3-prompt')">复制提示词</button>
                </div>
                <div class="example-section">
                    <h3>示例结果</h3>
                    <textarea id="step3-example" class="example-textarea" readonly></textarea>
                    <button class="copy-btn" onclick="copyText('step3-example')">复制示例</button>
                </div>
                <div class="combined-section">
                    <!-- 组合提示词不需要显示内容，只通过按钮复制 -->
                    <button class="copy-btn" id="copy-step3-combined" onclick="copyCombinedPrompt('step3')">一键复制组合提示词</button>
                </div>
            </div>
        </div>

        <div class="step-container">
            <div class="step-header" onclick="toggleStep(4)">
                <h3><i class="fas fa-chevron-right"></i> 第四步：生成JSON配置</h3>
            </div>
            <div class="step-content" id="step4-content">
                <div class="explanation-section">
                    <h3>说明：</h3>
                    <textarea id="step4-explanation" class="explanation-textarea" readonly></textarea>
                    <button class="copy-btn" onclick="copyText('step4-explanation')">复制说明</button>
                </div>
                <div class="json-merger">
                    <h4>JSON合并工具</h4>
                    <div class="form-group">
                        <label>输入多个JSON配置（每行一个）：</label>
                        <textarea id="json-inputs" rows="10" placeholder="在此粘贴多个JSON配置，每行一个..."></textarea>
                    </div>
                    <button class="merge-btn" onclick="mergeJsonConfigs()">
                        <i class="fas fa-code-merge"></i> 合并JSON
                    </button>
                    <div class="merge-actions">
                        <button class="copy-json-btn" onclick="copyMergedJson()">
                            <i class="fas fa-copy"></i> 复制合并后的JSON
                        </button>
                        <button class="download-json-btn" onclick="downloadMergedJson()">
                            <i class="fas fa-download"></i> 下载JSON文件
                        </button>
                    </div>
                    <div id="merged-json" class="merged-json"></div>
                </div>
            </div>
        </div>

        <div class="step-container">
            <div class="step-header" onclick="toggleStep(5)">
                <h3><i class="fas fa-chevron-right"></i> 第五步：生成分镜图片</h3>
            </div>
            <div class="step-content" id="step5-content">
                <div class="explanation-section">
                    <h3>说明：</h3>
                    <textarea id="step5-explanation" class="explanation-textarea" readonly></textarea>
                    <button class="copy-btn" onclick="copyText('step5-explanation')">复制说明</button>
                </div>
            </div>
        </div>

        <div class="step-container">
            <div class="step-header" onclick="toggleStep(6)">
                <h3><i class="fas fa-chevron-right"></i> 第六步：生成视频</h3>
            </div>
            <div class="step-content" id="step6-content">
                <div class="explanation-section">
                    <h3>说明：</h3>
                    <textarea id="step6-explanation" class="explanation-textarea" readonly></textarea>
                    <button class="copy-btn" onclick="copyText('step6-explanation')">复制说明</button>
                </div>
            </div>
        </div>
    </div>
</div>

        <!-- 配置区域 -->
        <div class="section">
            <h2 class="section-title"><i class="fas fa-cog"></i> 配置设置</h2>

            <div class="config-section">
                <!-- JSON 配置 -->
                <div class="config-card">
                    <h3><i class="fas fa-file-code"></i> 分镜配置</h3>
                    <div class="form-group">
                        <label>上传JSON配置:</label>
                        <div class="upload-area" id="json-upload-area">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>点击或拖放JSON文件</p>
                            <p class="upload-hint">支持自定义分镜配置</p>
                        </div>
                        <input type="file" id="json-upload" accept=".json" style="display: none;">
                    </div>

                    <div class="form-group">
                        <label>或输入JSON内容:</label>
                        <textarea id="json-content" rows="10" style="width: 100%; font-family: monospace;" placeholder="在此输入JSON配置内容..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>配置名称:</label>
                        <input type="text" id="config-name" placeholder="请输入配置名称" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>

                    <div class="form-group" style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="generate-btn" onclick="submitJson()">
                            <i class="fas fa-upload"></i> 提交配置
                        </button>
                    </div>

                    <div class="form-group">
                        <label>使用现有配置:</label>
                        <div class="config-list" id="config-list">
                            {% for config in configs %}
                            <div class="config-item" data-config-path="{{ config.path }}">
                                {{ config.name }}
                                <button class="delete-btn" style="margin-left: 10px; padding: 2px 8px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- 背景音乐 -->
                <div class="config-card">
                    <h3><i class="fas fa-music"></i> 背景音乐</h3>
                    <div class="form-group">
                        <label>上传背景音乐:</label>
                        <div class="upload-area" id="bgm-upload-area">
                            <i class="fas fa-music"></i>
                            <p>点击或拖放音频文件</p>
                            <p class="upload-hint">支持MP3, WAV, OGG格式</p>
                        </div>
                        <input type="file" id="bgm-upload" accept="audio/*">
                    </div>

                    <div class="form-group">
                        <label>背景音乐音量: <span id="bgm-volume-value" class="range-value">0.3</span></label>
                        <input type="range" id="bgm-volume" min="0" max="0.5" step="0.01" value="0.3">
                        <button id="preview-bgm" class="preview-btn" style="margin-top: 10px; padding: 5px 10px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-play"></i> 预览音量
                        </button>
                    </div>
                </div>

                <!-- 全局设置 -->
                <div class="config-card">
                    <h3><i class="fas fa-globe"></i> 全局设置</h3>
                    <div class="form-group">
                        <label>主题名称:</label>
                        <input type="text" id="theme-name" value="从祥林嫂的角度讲《彷徨》">
                    </div>

                    <div class="form-group">
                        <label>全局语音:</label>
                        <select id="global-voice">
                            {% for voice in voice_options %}
                            <option value="{{ voice.id }}">{{ voice.name }}</option>
                            {% endfor %}
                        </select>
                        <button class="voice-preview-btn" onclick="previewVoice('global')">
                            <i class="fas fa-play"></i> 预览语音
                        </button>
                        <button class="apply-global-btn" onclick="applyGlobalVoice()" style="margin-top: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">
                            <i class="fas fa-broadcast-tower"></i> 应用到所有分镜
                        </button>
                    </div>

                    <div class="form-group">
                        <label>全局音量: <span id="global-volume-value" class="range-value">1.0</span></label>
                        <input type="range" id="global-volume" min="0.1" max="2" step="0.1" value="1.0">
                        <button class="apply-global-btn" onclick="applyGlobalVolume()" style="margin-top: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">
                            <i class="fas fa-volume-up"></i> 应用到所有分镜
                        </button>
                    </div>

                    <div class="form-group">
                        <label>全局音调: <span id="global-pitch-value" class="range-value">0</span></label>
                        <input type="range" id="global-pitch" min="-10" max="10" value="0">
                        <button class="apply-global-btn" onclick="applyGlobalPitch()" style="margin-top: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">
                            <i class="fas fa-music"></i> 应用到所有分镜
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 封面区域 -->
        <div class="section">
            <h2 class="section-title"><i class="fas fa-image"></i> 封面设置</h2>

            <div class="upload-area" id="cover-upload-area">
                <i class="fas fa-image"></i>
                <p>点击或拖放封面图片</p>
                <p class="upload-hint">建议尺寸: 1080x1920</p>
            </div>
            <input type="file" id="cover-upload" accept="image/*">
            <div class="preview-container">
                <img id="cover-preview" class="preview-image" alt="封面预览">
            </div>
        </div>

        <!-- 分镜列表 -->
        <div class="section">
            <h2 class="section-title"><i class="fas fa-film"></i> 分镜设置</h2>

            <div class="storyboard-container">
                <div class="storyboard-header">
                    <h2>分镜设置</h2>
                </div>
                <div id="storyboard" class="storyboard"></div>
            </div>
        </div>

        <!-- 进度条 -->
        <div class="progress-container" id="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-text" id="progress-text">准备生成视频...</div>
        </div>

        <button id="generate-btn" class="generate-btn" onclick="generateVideo()">
            <i class="fas fa-play-circle"></i> 生成视频
        </button>

        <!-- 视频列表 -->
        {% if videos %}
        <div class="videos-section">
            <h2 class="section-title"><i class="fas fa-play-circle"></i> 生成的视频</h2>
            <div class="video-list">
                {% for video in videos %}
                <div class="video-item">
                    <div class="video-thumb">
                        <i class="fas fa-film"></i>
                    </div>
                    <div class="video-info">
                        <div class="video-title">{{ video }}</div>
                        <div class="video-actions">
                            <a href="/static/videos/{{ video }}" target="_blank">
                                <i class="fas fa-eye"></i> 观看
                            </a>
                            <a href="/static/videos/{{ video }}" download>
                                <i class="fas fa-download"></i> 下载
                            </a>
                            <button class="delete-video-btn" data-video-path="/static/videos/{{ video }}" style="padding: 8px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

      

        <script>
            // 存储上传的文件信息
            const uploadedFiles = {
                cover: null,
                scenes: {},
                bgm: null,
                config: null
            };

            // 显示错误信息
            function showError(message) {
                const errorContainer = document.getElementById('error-container');
                errorContainer.textContent = message;
                errorContainer.style.display = 'block';
                setTimeout(() => {
                    errorContainer.style.display = 'none';
                }, 5000);
            }

            // 设置拖放功能
            function setupDragDrop(container, type) {
                if (type === 'cover') {
                    container.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        container.classList.add('drag-over');
                    });

                    container.addEventListener('dragleave', () => {
                        container.classList.remove('drag-over');
                    });

                    container.addEventListener('drop', (e) => {
                        e.preventDefault();
                        container.classList.remove('drag-over');

                        if (e.dataTransfer.files.length > 0) {
                            const file = e.dataTransfer.files[0];
                            if (file.type.startsWith('image/')) {
                                uploadCoverFile(file);
                            } else {
                                showError('请上传图片文件');
                            }
                        }
                    });
                } else if (type === 'scene') {
                    container.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        container.classList.add('drag-over');
                    });

                    container.addEventListener('dragleave', () => {
                        container.classList.remove('drag-over');
                    });

                    container.addEventListener('drop', (e) => {
                        e.preventDefault();
                        container.classList.remove('drag-over');

                        if (e.dataTransfer.files.length > 0) {
                            const file = e.dataTransfer.files[0];
                            if (file.type.startsWith('image/')) {
                                const sceneId = container.closest('.scene-card').dataset.sceneId;
                                handleSceneImageUpload({ target: { files: [file] } }, sceneId);
                            } else {
                                showError('请上传图片文件');
                            }
                        }
                    });
                }
            }

            // 初始化拖放功能
            function initDragAndDrop() {
                // 封面拖放
                const coverArea = document.getElementById('cover-upload-area');
                const coverUpload = document.getElementById('cover-upload');

                coverArea.addEventListener('click', () => {
                    coverUpload.click();
                });

                // JSON配置拖放
                const jsonArea = document.getElementById('json-upload-area');
                const jsonUpload = document.getElementById('json-upload');

                jsonArea.addEventListener('click', () => {
                    jsonUpload.click();
                });

                // BGM拖放
                const bgmArea = document.getElementById('bgm-upload-area');
                const bgmUpload = document.getElementById('bgm-upload');

                bgmArea.addEventListener('click', () => {
                    bgmUpload.click();
                });

                // 场景拖放
                document.querySelectorAll('.scene-card').forEach(card => {
                    const sceneId = card.dataset.sceneId;
                    const uploadArea = card.querySelector('.scene-upload-area');

                    uploadArea.addEventListener('click', () => {
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = 'image/*';
                        input.onchange = (e) => handleSceneImageUpload(e, sceneId);
                        input.click();
                    });

                    setupDragDrop(uploadArea, 'scene');
                });

                // 设置封面拖放事件
                setupDragDrop(coverArea, 'cover');
                setupDragDrop(jsonArea, 'json');
                setupDragDrop(bgmArea, 'bgm');
            }

            // 处理分镜图片上传
            async function handleSceneImageUpload(event, sceneId) {
                const file = event.target.files[0];
                if (!file) return;

                try {
                    const formData = new FormData();
                    formData.append('file', file);

                    const response = await fetch(`/upload/${sceneId}`, {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    if (data.status === 'success') {
                        uploadedFiles.scenes[sceneId] = data.file_path;
                        
                        // 显示预览
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const preview = document.querySelector(`.scene-preview[data-scene-id="${sceneId}"]`);
                            if (preview) {
                                preview.src = e.target.result;
                                preview.style.display = 'block';
                            }
                        };
                        reader.readAsDataURL(file);
                    } else {
                        throw new Error(data.error || '上传失败');
                    }
                } catch (error) {
                    showError(`分镜 ${sceneId} 上传失败: ${error.message}`);
                }
            }

            // 初始化滑块事件
            function initSliders() {
                // BGM音量
                const bgmVolume = document.getElementById('bgm-volume');
                const bgmVolumeValue = document.getElementById('bgm-volume-value');
                const previewBgmBtn = document.getElementById('preview-bgm');
                let bgmAudio = null;

                bgmVolume.addEventListener('input', function() {
                    bgmVolumeValue.textContent = this.value;
                    if (bgmAudio) {
                        bgmAudio.volume = parseFloat(this.value);
                    }
                });

                previewBgmBtn.addEventListener('click', function() {
                    if (uploadedFiles.bgm) {
                        if (bgmAudio) {
                            bgmAudio.pause();
                            bgmAudio = null;
                        } else {
                            // 从文件路径中提取文件名
                            const fileName = uploadedFiles.bgm.split('/').pop();
                            // 使用服务器URL
                            const audioUrl = `/static/uploads/${fileName}`;
                            bgmAudio = new Audio(audioUrl);
                            bgmAudio.volume = parseFloat(bgmVolume.value);
                            bgmAudio.play();
                            this.innerHTML = '<i class="fas fa-stop"></i> 停止预览';
                        }
                    } else {
                        showError('请先上传背景音乐');
                    }
                });

                // 默认音量
                const defaultVolume = document.getElementById('global-volume');
                const defaultVolumeValue = document.getElementById('global-volume-value');

                defaultVolume.addEventListener('input', function() {
                    defaultVolumeValue.textContent = this.value;
                    // 更新所有分镜的默认音量
                    document.querySelectorAll('.volume-slider').forEach(slider => {
                        slider.value = this.value;
                        slider.previousElementSibling.querySelector('.volume-value').textContent = this.value;
                    });
                });

                // 分镜音量和音调
                document.querySelectorAll('.scene-card').forEach(card => {
                    const volumeSlider = card.querySelector('.volume-slider');
                    const volumeValue = card.querySelector('.volume-value');
                    const pitchSlider = card.querySelector('.pitch-slider');
                    const pitchValue = card.querySelector('.pitch-value');

                    volumeSlider.addEventListener('input', function() {
                        volumeValue.textContent = this.value;
                    });

                    pitchSlider.addEventListener('input', function() {
                        pitchValue.textContent = this.value;
                    });
                });
            }

            // 初始化配置选择
            function initConfigSelection() {
                document.querySelectorAll('.config-item').forEach(item => {
                    item.addEventListener('click', function(e) {
                        if (!e.target.closest('.delete-btn')) {
                            const configPath = this.dataset.configPath;
                            loadConfig(configPath);
                        }
                    });
                });

                // 初始化删除按钮
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', async function(e) {
                        e.stopPropagation();
                        const configItem = this.closest('.config-item');
                        const configPath = configItem.dataset.configPath;
                        
                        if (confirm('确定要删除这个配置文件吗？')) {
                            try {
                                const response = await fetch('/delete_file', {
                                    method: 'DELETE',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ file_path: configPath })
                                });

                                if (response.ok) {
                                    configItem.remove();
                                    showError('配置文件删除成功！');
                                } else {
                                    const error = await response.json();
                                    throw new Error(error.detail || '删除失败');
                                }
                            } catch (error) {
                                showError(`删除配置文件失败: ${error.message}`);
                            }
                        }
                    });
                });
            }

            // 初始化视频删除按钮
            function initVideoDeletion() {
                document.querySelectorAll('.delete-video-btn').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        const videoPath = this.dataset.videoPath;
                        if (confirm('确定要删除这个视频吗？')) {
                            try {
                                // 从路径中提取文件名
                                const fileName = videoPath.split('/').pop();
                                const response = await fetch('/delete_file', {
                                    method: 'DELETE',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        file_path: `/static/videos/${fileName}`
                                    })
                                });

                                if (response.ok) {
                                    const data = await response.json();
                                    if (data.status === 'success') {
                                        this.closest('.video-item').remove();
                                        showError('视频删除成功！');
                                    } else {
                                        throw new Error(data.message || '删除失败');
                                    }
                                } else {
                                    const error = await response.json();
                                    throw new Error(error.detail || '删除失败');
                                }
                            } catch (error) {
                                showError(`删除视频失败: ${error.message}`);
                            }
                        }
                    });
                });
            }

            // 加载配置
            async function loadConfig(filename) {
                try {
                    const response = await fetch(`/load_config/${encodeURIComponent(filename)}`);
                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.detail || '加载失败');
                    }

                    const data = await response.json();
                    if (data.status === 'success') {
                        const configData = data.config;
                        console.log('加载的配置数据:', configData); // 添加调试日志
                        uploadedFiles.config = filename;

                        // 更新主题名称
                        document.getElementById('theme-name').value = configData['分镜结构']['封面提示词']['主题'] || '从祥林嫂的角度讲《彷徨》';

                        // 更新分镜列表
                        const storyboard = document.getElementById('storyboard');
                        storyboard.innerHTML = '';
                        
                        if (configData['分镜结构'] && configData['分镜结构']['分镜列表']) {
                            configData['分镜结构']['分镜列表'].forEach((scene, index) => {
                                console.log('处理分镜:', scene); // 添加调试日志
                                const sceneCard = createSceneCard(index + 1, scene);
                                storyboard.appendChild(sceneCard);
                            });
                        } else {
                            console.error('配置数据中缺少分镜列表');
                            showError('配置数据格式错误：缺少分镜列表');
                        }

                        // 更新全局设置
                        if (configData['分镜结构'] && configData['分镜结构']['全局设置']) {
                            const settings = configData['分镜结构']['全局设置'];
                            document.getElementById('global-voice').value = settings['全局语音'] || 'zh-CN-XiaoxiaoNeural';
                            document.getElementById('global-speed').value = settings['全局语速'] || '1.0';
                            document.getElementById('global-pitch').value = settings['全局音调'] || '0';
                            document.getElementById('bgm-volume').value = settings['背景音乐音量'] || '0.5';
                        }

                        showError('配置加载成功！');
                    } else {
                        throw new Error(data.detail || '加载失败');
                    }
                } catch (error) {
                    console.error('加载配置失败:', error); // 添加调试日志
                    showError(`加载配置失败: ${error.message}`);
                }
            }

            // 创建分镜卡片
            function createSceneCard(index, scene) {
                console.log('创建分镜卡片:', scene);
                const sceneCard = document.createElement('div');
                sceneCard.className = 'scene-card';
                sceneCard.dataset.sceneId = scene['分镜编号'];

                const positivePrompts = Array.isArray(scene['正向提示词']) ? scene['正向提示词'] : [];
                const negativePrompts = Array.isArray(scene['负向提示词']) ? scene['负向提示词'] : [];
                const chineseSubtitle = scene['字幕'] && scene['字幕']['中文'] ? scene['字幕']['中文'] : '';
                const englishSubtitle = scene['字幕'] && scene['字幕']['英文'] ? scene['字幕']['英文'] : '';
                const duration = scene['时长'] || '0';
                const voice = scene['语音'] || 'zh-CN-YunxiNeural';
                const volume = scene['音量'] || 1.0;
                const pitch = scene['音调'] || 0;

                sceneCard.innerHTML = `
                    <div class="scene-header" onclick="toggleSceneContent(this)">
                        <span class="scene-number">
                            <i class="fas fa-chevron-down"></i>
                            分镜 ${scene['分镜编号']}
                        </span>
                        <span class="scene-duration">${duration}秒</span>
                    </div>

                    <div class="scene-content">
                        <div class="prompts">
                            <strong>正向提示词:</strong>
                            <div class="prompt-list">
                                <span class="prompt-text">${positivePrompts.join(', ')}</span>
                                <button class="copy-btn" onclick="copyPromptText(this)">
                                    <i class="fas fa-copy"></i> 复制
                                </button>
                            </div>
                        </div>

                        <div class="prompts">
                            <strong>负向提示词:</strong>
                            <div class="prompt-list">
                                <span class="prompt-text">${negativePrompts.join(', ')}</span>
                                <button class="copy-btn" onclick="copyPromptText(this)">
                                    <i class="fas fa-copy"></i> 复制
                                </button>
                            </div>
                        </div>

                        <div class="subtitle-section">
                            <strong>中文字幕:</strong>
                            <textarea class="chinese-sub" rows="2">${chineseSubtitle}</textarea>
                        </div>

                        <div class="subtitle-section">
                            <strong>英文字幕:</strong>
                            <textarea class="english-sub" rows="2">${englishSubtitle}</textarea>
                        </div>

                        <div class="voice-settings">
                            <div class="voice-setting">
                                <label>语音角色:</label>
                                <select class="voice-select">
                                    {% for voice in voice_options %}
                                    <option value="{{ voice.id }}" ${voice.id === voice ? 'selected' : ''}>
                                        {{ voice.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <button class="voice-preview-btn" onclick="previewVoice('scene', '${scene['分镜编号']}')">
                                    <i class="fas fa-play"></i> 预览语音
                                </button>
                            </div>

                            <div class="voice-setting">
                                <label>音量: <span class="volume-value range-value">${volume}</span></label>
                                <input type="range" class="volume-slider" min="0.1" max="2" step="0.1" value="${volume}">
                            </div>

                            <div class="voice-setting">
                                <label>音调: <span class="pitch-value range-value">${pitch}</span></label>
                                <input type="range" class="pitch-slider" min="-10" max="10" value="${pitch}">
                            </div>
                        </div>

                        <div class="upload-area scene-upload-area">
                            <i class="fas fa-image"></i>
                            <p>点击或拖放分镜图片</p>
                            <p class="upload-hint">建议尺寸: 1080x1920</p>
                        </div>
                        <img class="preview-image scene-preview"
                             data-scene-id="${scene['分镜编号']}"
                             alt="分镜 ${scene['分镜编号']}预览"
                             style="display: none;">
                    </div>
                `;

                // 添加语音选择事件监听
                const voiceSelect = sceneCard.querySelector('.voice-select');
                voiceSelect.value = voice;
                voiceSelect.addEventListener('change', function() {
                    const sceneId = sceneCard.dataset.sceneId;
                    if (!uploadedFiles.scenes[sceneId]) {
                        uploadedFiles.scenes[sceneId] = {};
                    }
                    uploadedFiles.scenes[sceneId].voice = this.value;
                });

                // 添加音量滑块事件监听
                const volumeSlider = sceneCard.querySelector('.volume-slider');
                const volumeValue = sceneCard.querySelector('.volume-value');
                volumeSlider.value = volume;
                volumeSlider.addEventListener('input', function() {
                    volumeValue.textContent = this.value;
                    const sceneId = sceneCard.dataset.sceneId;
                    if (!uploadedFiles.scenes[sceneId]) {
                        uploadedFiles.scenes[sceneId] = {};
                    }
                    uploadedFiles.scenes[sceneId].volume = parseFloat(this.value);
                });

                // 添加音调滑块事件监听
                const pitchSlider = sceneCard.querySelector('.pitch-slider');
                const pitchValue = sceneCard.querySelector('.pitch-value');
                pitchSlider.value = pitch;
                pitchSlider.addEventListener('input', function() {
                    pitchValue.textContent = this.value;
                    const sceneId = sceneCard.dataset.sceneId;
                    if (!uploadedFiles.scenes[sceneId]) {
                        uploadedFiles.scenes[sceneId] = {};
                    }
                    uploadedFiles.scenes[sceneId].pitch = parseInt(this.value);
                });

                // 添加图片上传事件监听
                const uploadArea = sceneCard.querySelector('.scene-upload-area');
                const previewImage = sceneCard.querySelector('.scene-preview');
                
                uploadArea.addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.onchange = (e) => handleSceneImageUpload(e, scene['分镜编号']);
                    input.click();
                });

                setupDragDrop(uploadArea, 'scene');

                return sceneCard;
            }

            // 上传封面文件
            async function uploadCoverFile(file) {
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/upload/cover', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    if (data.status === 'success') {
                        uploadedFiles.cover = data.file_path;
                        // 显示预览
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const preview = document.getElementById('cover-preview');
                            preview.src = e.target.result;
                            preview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    } else {
                        throw new Error(data.error || '上传失败');
                    }
                } catch (error) {
                    showError(`封面上传失败: ${error.message}`);
                }
            }

            // 提交JSON配置
            async function submitJson() {
                const configName = document.getElementById('config-name').value.trim();
                if (!configName) {
                    showError('请输入配置名称');
                    return;
                }

                const fileInput = document.getElementById('json-upload');
                const jsonContent = document.getElementById('json-content').value.trim();
                const formData = new FormData();
                formData.append('config_name', configName);

                try {
                    // 优先使用文件上传
                    if (fileInput.files && fileInput.files.length > 0) {
                        formData.append('file', fileInput.files[0]);
                    } else if (jsonContent) {
                        formData.append('json_content', jsonContent);
                    } else {
                        showError('请上传JSON文件或输入JSON内容');
                        return;
                    }

                    const response = await fetch('/upload_config', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    if (data.status === 'success') {
                        uploadedFiles.config = data.file_path;
                        // 加载配置
                        loadConfig(data.file_path);
                        // 清空输入
                        document.getElementById('config-name').value = '';
                        document.getElementById('json-content').value = '';
                        fileInput.value = '';
                        // 刷新配置列表
                        loadConfigList();
                    } else if (response.status === 409) {
                        // 文件已存在，询问是否覆盖
                        if (confirm('配置文件已存在，是否覆盖？')) {
                            // 删除旧文件
                            await deleteConfig(data.file_path);
                            // 重新提交
                            await submitJson();
                        }
                    } else {
                        throw new Error(data.detail || '提交失败');
                    }
                } catch (error) {
                    showError(`JSON提交失败: ${error.message}`);
                }
            }

            // 上传BGM
            async function uploadBgmFile(file) {
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/upload_bgm', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    if (data.status === 'success') {
                        uploadedFiles.bgm = data.file_path;
                        showError('背景音乐上传成功！');
                    } else {
                        throw new Error(data.error || '上传失败');
                    }
                } catch (error) {
                    showError(`背景音乐上传失败: ${error.message}`);
                }
            }

            // 文件选择变化时自动上传
            function initAutoUpload() {
                document.getElementById('cover-upload').addEventListener('change', function() {
                    if (this.files.length > 0) {
                        uploadCoverFile(this.files[0]);
                    }
                });

                document.getElementById('json-upload').addEventListener('change', function() {
                    if (this.files.length > 0) {
                        submitJson();
                    }
                });

                document.getElementById('bgm-upload').addEventListener('change', function() {
                    if (this.files.length > 0) {
                        uploadBgmFile(this.files[0]);
                    }
                });
            }

            // 更新进度条
            function updateProgress(percent, message) {
                const progressFill = document.getElementById('progress-fill');
                const progressText = document.getElementById('progress-text');
                const progressContainer = document.getElementById('progress-container');

                progressContainer.style.display = 'block';
                progressFill.style.width = `${percent}%`;
                progressText.textContent = message;
            }

            // 生成视频
            async function generateVideo() {
                const generateBtn = document.getElementById('generate-btn');
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 生成中...';

                try {
                    updateProgress(0, "准备生成视频...");

                    // 收集所有修改后的字幕
                    const scenes = [];
                    document.querySelectorAll('.scene-card').forEach(card => {
                        const sceneId = card.dataset.sceneId;
                        const chineseSub = card.querySelector('.chinese-sub').value;
                        const englishSub = card.querySelector('.english-sub').value;
                        const imageFile = uploadedFiles.scenes[sceneId] || '';
                        const voice = card.querySelector('.voice-select').value;
                        const volume = parseFloat(card.querySelector('.volume-slider').value);
                        const pitch = parseInt(card.querySelector('.pitch-slider').value);

                        scenes.push({
                            scene_id: parseInt(sceneId),
                            chinese_subtitle: chineseSub,
                            english_subtitle: englishSub,
                            image_path: imageFile,
                            voice: voice,
                            volume: volume,
                            pitch: pitch
                        });

                        updateProgress(10, `处理分镜 ${sceneId}...`);
                    });

                    // 检查是否上传了封面
                    if (!uploadedFiles.cover) {
                        throw new Error('请上传封面图片');
                    }

                    // 检查是否有至少一个分镜图片
                    const hasSceneImage = Object.values(uploadedFiles.scenes).some(path => path);
                    if (!hasSceneImage) {
                        throw new Error('请至少上传一个分镜图片');
                    }

                    // 获取主题名称
                    const theme = document.getElementById('theme-name').value || "从祥林嫂的角度讲《彷徨》";

                    // 发送生成请求
                    const requestData = {
                        cover_image: uploadedFiles.cover,
                        scenes: scenes,
                        theme: theme,
                        bgm_path: uploadedFiles.bgm || null,
                        bgm_volume: parseFloat(document.getElementById('bgm-volume').value)
                    };

                    updateProgress(30, "生成音频内容...");

                    const response = await fetch('/generate_video', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || '视频生成失败');
                    }

                    updateProgress(80, "合成最终视频...");

                    const result = await response.json();
                    if (result.status === 'success') {
                        updateProgress(100, "视频生成成功！");
                        setTimeout(() => {
                            // 刷新页面以显示新生成的视频
                            location.reload();
                        }, 1500);
                    } else {
                        throw new Error(result.message || '视频生成失败');
                    }
                } catch (error) {
                    showError('视频生成失败: ' + error.message);
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '<i class="fas fa-play-circle"></i> 生成视频';
                }
            }

            // 删除配置文件
            async function deleteConfig(filename) {
                if (!confirm('确定要删除这个配置文件吗？')) {
                    return;
                }

                try {
                    const response = await fetch(`/delete_file?file_path=${encodeURIComponent(filename)}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.detail || '删除失败');
                    }

                    const data = await response.json();
                    if (data.status === 'success') {
                        // 从列表中移除
                        const configItem = document.querySelector(`.config-item[data-filename="${filename}"]`);
                        if (configItem) {
                            configItem.remove();
                        }
                        // 如果删除的是当前加载的配置，清空当前配置
                        if (uploadedFiles.config === filename) {
                            uploadedFiles.config = null;
                            document.getElementById('storyboard').innerHTML = '';
                        }
                        // 刷新配置列表
                        loadConfigList();
                    } else {
                        throw new Error(data.message || '删除失败');
                    }
                } catch (error) {
                    showError(`删除配置文件失败: ${error.message}`);
                }
            }

            // 加载配置列表
            async function loadConfigList() {
                try {
                    const response = await fetch('/list_configs');
                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.detail || '加载失败');
                    }

                    const data = await response.json();
                    if (data.status === 'success') {
                        const configList = document.getElementById('config-list');
                        configList.innerHTML = '';
                        data.configs.forEach(config => {
                            const configItem = document.createElement('div');
                            configItem.className = 'config-item';
                            configItem.setAttribute('data-filename', config);
                            configItem.innerHTML = `
                                <span>${config}</span>
                                <button onclick="loadConfig('${config}')">加载</button>
                                <button onclick="deleteConfig('${config}')">删除</button>
                            `;
                            configList.appendChild(configItem);
                        });
                    }
                } catch (error) {
                    showError(`加载配置列表失败: ${error.message}`);
                }
            }

            // 应用全局语音设置
            function applyGlobalVoice() {
                const globalVoice = document.getElementById('global-voice').value;
                document.querySelectorAll('.scene-card').forEach(card => {
                    const voiceSelect = card.querySelector('.voice-select');
                    voiceSelect.value = globalVoice;
                    
                    // 触发change事件以更新数据
                    const event = new Event('change');
                    voiceSelect.dispatchEvent(event);
                });
                showError('已将所有分镜的语音角色设置为: ' + globalVoice);
            }

            // 应用全局音量设置
            function applyGlobalVolume() {
                const globalVolume = document.getElementById('global-volume').value;
                document.querySelectorAll('.scene-card').forEach(card => {
                    const volumeSlider = card.querySelector('.volume-slider');
                    const volumeValue = card.querySelector('.volume-value');
                    volumeSlider.value = globalVolume;
                    volumeValue.textContent = globalVolume;
                    
                    // 触发input事件以更新数据
                    const event = new Event('input');
                    volumeSlider.dispatchEvent(event);
                });
                showError('已将所有分镜的音量设置为: ' + globalVolume);
            }

            // 应用全局音调设置
            function applyGlobalPitch() {
                const globalPitch = document.getElementById('global-pitch').value;
                document.querySelectorAll('.scene-card').forEach(card => {
                    const pitchSlider = card.querySelector('.pitch-slider');
                    const pitchValue = card.querySelector('.pitch-value');
                    pitchSlider.value = globalPitch;
                    pitchValue.textContent = globalPitch;
                    
                    // 触发input事件以更新数据
                    const event = new Event('input');
                    pitchSlider.dispatchEvent(event);
                });
                showError('已将所有分镜的音调设置为: ' + globalPitch);
            }

            // 初始化全局设置
            function initGlobalSettings() {
                const globalVolume = document.getElementById('global-volume');
                const globalVolumeValue = document.getElementById('global-volume-value');
                const globalPitch = document.getElementById('global-pitch');
                const globalPitchValue = document.getElementById('global-pitch-value');

                globalVolume.addEventListener('input', function() {
                    globalVolumeValue.textContent = this.value;
                });

                globalPitch.addEventListener('input', function() {
                    globalPitchValue.textContent = this.value;
                });
            }

            // 语音预览功能
            let currentPreview = null;
            let previewAudio = null;

            async function previewVoice(type, sceneId = null) {
                const previewBtn = type === 'global' 
                    ? document.querySelector('#global-voice').nextElementSibling
                    : document.querySelector(`.scene-card[data-scene-id="${sceneId}"] .voice-preview-btn`);
                
                const voiceSelect = type === 'global'
                    ? document.getElementById('global-voice')
                    : document.querySelector(`.scene-card[data-scene-id="${sceneId}"] .voice-select`);
                
                const volumeSlider = type === 'global'
                    ? document.getElementById('global-volume')
                    : document.querySelector(`.scene-card[data-scene-id="${sceneId}"] .volume-slider`);
                
                const pitchSlider = type === 'global'
                    ? document.getElementById('global-pitch')
                    : document.querySelector(`.scene-card[data-scene-id="${sceneId}"] .pitch-slider`);

                // 如果正在播放，停止播放
                if (currentPreview === previewBtn) {
                    if (previewAudio) {
                        previewAudio.pause();
                        previewAudio = null;
                    }
                    previewBtn.innerHTML = '<i class="fas fa-play"></i> 预览语音';
                    previewBtn.classList.remove('playing');
                    currentPreview = null;
                    return;
                }

                // 停止其他正在播放的预览
                if (currentPreview) {
                    currentPreview.innerHTML = '<i class="fas fa-play"></i> 预览语音';
                    currentPreview.classList.remove('playing');
                    if (previewAudio) {
                        previewAudio.pause();
                        previewAudio = null;
                    }
                }

                // 开始新的预览
                try {
                    const text = type === 'global' 
                        ? "这是一段测试语音，用于预览当前选择的语音效果。"
                        : document.querySelector(`.scene-card[data-scene-id="${sceneId}"] .chinese-sub`).value || "这是一段测试语音，用于预览当前选择的语音效果。";

                    const formData = new FormData();
                    formData.append('text', text);
                    formData.append('voice', voiceSelect.value);
                    formData.append('volume', volumeSlider.value);
                    formData.append('pitch', pitchSlider.value);

                    const response = await fetch('/preview_voice', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error('预览生成失败');
                    }

                    const blob = await response.blob();
                    const audioUrl = URL.createObjectURL(blob);
                    
                    previewAudio = new Audio(audioUrl);
                    previewAudio.onended = () => {
                        previewBtn.innerHTML = '<i class="fas fa-play"></i> 预览语音';
                        previewBtn.classList.remove('playing');
                        currentPreview = null;
                        URL.revokeObjectURL(audioUrl);
                    };

                    previewBtn.innerHTML = '<i class="fas fa-stop"></i> 停止预览';
                    previewBtn.classList.add('playing');
                    currentPreview = previewBtn;
                    
                    await previewAudio.play();
                } catch (error) {
                    showError(`预览失败: ${error.message}`);
                    previewBtn.innerHTML = '<i class="fas fa-play"></i> 预览语音';
                    previewBtn.classList.remove('playing');
                }
            }

            // 切换步骤显示/隐藏
            function toggleStep(stepNumber) {
                const content = document.getElementById(`step${stepNumber}-content`);
                const header = content.previousElementSibling;
                const icon = header.querySelector('i');
                
                if (content.style.display === 'block') {
                    content.style.display = 'none';
                    icon.className = 'fas fa-chevron-right';
                } else {
                    content.style.display = 'block';
                    icon.className = 'fas fa-chevron-down';
                }
            }

            // 切换分镜内容显示/隐藏
            function toggleSceneContent(header) {
                const sceneCard = header.closest('.scene-card');
                const content = sceneCard.querySelector('.scene-content');
                const icon = header.querySelector('i');
                
                if (content.classList.contains('collapsed')) {
                    content.classList.remove('collapsed');
                    header.classList.remove('collapsed');
                    icon.className = 'fas fa-chevron-down';
                } else {
                    content.classList.add('collapsed');
                    header.classList.add('collapsed');
                    icon.className = 'fas fa-chevron-right';
                }
            }

            // 复制提示词文本
            function copyPromptText(button) {
                const promptList = button.closest('.prompt-list');
                const promptText = promptList.querySelector('.prompt-text');
                const textToCopy = promptText.textContent.trim();
                
                navigator.clipboard.writeText(textToCopy).then(() => {
                    // 显示复制成功反馈
                    const originalText = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-check"></i> 已复制';
                    button.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
                    
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.style.background = 'linear-gradient(135deg, #3498db, #2980b9)';
                    }, 1500);
                }).catch(err => {
                    showError('复制失败: ' + err);
                });
            }

            // 内容拆分功能
            function splitContent() {
                const content = document.getElementById('article-content').value;
                const minLength = parseInt(document.getElementById('min-length').value);
                const maxLength = parseInt(document.getElementById('max-length').value);
                const delimiters = document.getElementById('split-delimiters').value;
                
                if (!content) {
                    showError('请输入需要拆分的内容');
                    return;
                }

                // 构建分割符正则
                const delimiterRegex = new RegExp(`[${delimiters}]`, 'g');
                let parts = [];
                let current = '';
                
                for (let i = 0; i < content.length; i++) {
                    current += content[i];
                    if (delimiterRegex.test(content[i]) || current.length >= maxLength) {
                        if (current.length >= minLength) {
                            parts.push(current.trim());
                            current = '';
                        } else if (current.length >= maxLength) {
                            parts.push(current.trim());
                            current = '';
                        }
                    }
                }
                
                if (current.trim().length > 0) {
                    parts.push(current.trim());
                }

                // 显示拆分结果
                const resultsContainer = document.getElementById('split-results');
                resultsContainer.innerHTML = '';
                
                if (parts.length === 0) {
                    resultsContainer.innerHTML = '<p style="text-align: center; color: #7f8c8d;">没有找到合适的分割点</p>';
                    return;
                }

                resultsContainer.innerHTML = `
                    <h5><i class="fas fa-list"></i> 拆分结果 (共${parts.length}部分)</h5>
                `;
                
                parts.forEach((part, index) => {
                    const splitItem = document.createElement('div');
                    splitItem.className = 'split-item';
                    splitItem.innerHTML = `
                        <div class="split-item-header">
                            <span class="split-item-title">第${index + 1}部分 (${part.length}字)</span>
                            <button class="copy-btn" onclick="copySplitContent(this)">
                                <i class="fas fa-copy"></i> 一键复制
                            </button>
                        </div>
                        <div class="split-item-content">
                            <textarea class="split-textarea" rows="6" readonly>${part}</textarea>
                        </div>
                    `;
                    resultsContainer.appendChild(splitItem);
                });
            }

            // 复制拆分内容
            function copySplitContent(button) {
                const splitItem = button.closest('.split-item');
                const textarea = splitItem.querySelector('.split-textarea');
                const textToCopy = textarea.value;
                
                navigator.clipboard.writeText(textToCopy).then(() => {
                    // 显示复制成功反馈
                    const originalText = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-check"></i> 已复制';
                    button.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
                    
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.style.background = 'linear-gradient(135deg, #3498db, #2980b9)';
                    }, 1500);
                }).catch(err => {
                    showError('复制失败: ' + err);
                });
            }

            // 复制文本
            function copyText(elementId) {
                const textarea = document.getElementById(elementId);
                if (textarea) {
                    const textToCopy = textarea.value;
                    
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        // 显示复制成功反馈
                        const button = textarea.nextElementSibling;
                        if (button && button.classList.contains('copy-btn')) {
                            const originalText = button.innerHTML;
                            button.innerHTML = '<i class="fas fa-check"></i> 已复制';
                            button.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
                            
                            setTimeout(() => {
                                button.innerHTML = originalText;
                                button.style.background = 'linear-gradient(135deg, #3498db, #2980b9)';
                            }, 1500);
                        } else {
                            showError('复制成功！');
                        }
                    }).catch(err => {
                        // 降级到传统方法
                        textarea.select();
                        document.execCommand('copy');
                        showError('复制成功！');
                    });
                } else {
                    showError('复制失败：目标元素不存在！');
                }
            }
            
            // 复制组合提示词
            async function copyCombinedPrompt(stepName) {
                try {
                    const combinedContent = await loadCombinedGuideContent(stepName);
                    navigator.clipboard.writeText(combinedContent).then(() => {
                        // 显示复制成功反馈
                        const button = document.getElementById(`copy-${stepName}-combined`);
                        if (button) {
                            const originalText = button.innerHTML;
                            button.innerHTML = '<i class="fas fa-check"></i> 已复制';
                            button.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
                            
                            setTimeout(() => {
                                button.innerHTML = originalText;
                                button.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
                            }, 1500);
                        } else {
                            showError('组合提示词已复制到剪贴板！');
                        }
                    }).catch(err => {
                        showError('复制失败: ' + err);
                    });
                } catch (error) {
                    showError('复制失败: ' + error.message);
                }
            }

            // JSON合并功能
            function mergeJsonConfigs() {
                const jsonInputs = document.getElementById('json-inputs').value;
                if (!jsonInputs) {
                    showError('请输入需要合并的JSON配置');
                    return;
                }

                try {
                    // 分割输入的JSON字符串
                    const jsonStrings = jsonInputs.split(/\s*\n\s*\n\s*|\s*\n\s*\n/g).filter(str => str.trim());
                    // 确保每个字符串都是合法的JSON
                    const parsedJson = jsonStrings.map(jsonStr => {
                        try {
                            return JSON.parse(jsonStr);
                        } catch (e) {
                            throw new Error(`无效的JSON格式在其中一部分: ${e.message}。内容: ${jsonStr.substring(0, 50)}...`);
                        }
                    });

                    const mergedConfig = {
                        "分镜结构": {
                            "封面提示词": {
                                "主题": "",
                                "正向提示词": [],
                                "负向提示词": []
                            },
                            "分镜列表": []
                        }
                    };

                    // 合并所有JSON配置
                    parsedJson.forEach((config, index) => {
                        // 如果是第一个配置，使用其封面提示词
                        if (index === 0) {
                            if (config.分镜结构 && config.分镜结构.封面提示词) {
                                mergedConfig.分镜结构.封面提示词 = config.分镜结构.封面提示词;
                            }
                        }
                        
                        // 合并分镜列表
                        if (config.分镜结构 && config.分镜结构.分镜列表) {
                            config.分镜结构.分镜列表.forEach(scene => {
                                // 确保分镜编号唯一且递增
                                const newSceneId = mergedConfig.分镜结构.分镜列表.length + 1;
                                mergedConfig.分镜结构.分镜列表.push({
                                    ...scene,
                                    "分镜编号": String(newSceneId) // 转换为字符串，与后端保持一致
                                });
                            });
                        }
                    });

                    // 显示合并后的JSON
                    const mergedJsonElement = document.getElementById('merged-json');
                    if (mergedJsonElement) {
                        mergedJsonElement.textContent = JSON.stringify(mergedConfig, null, 2);
                        // 保存合并后的JSON到全局变量
                        window.mergedJsonConfig = mergedConfig;
                        showError('JSON配置合并成功！');
                    } else {
                        showError('JSON合并结果显示区域不存在。');
                    }
                } catch (error) {
                    showError('JSON合并失败: ' + error.message);
                }
            }

            // 复制合并后的JSON
            function copyMergedJson() {
                if (!window.mergedJsonConfig) {
                    showError('请先合并JSON配置');
                    return;
                }
                
                const jsonString = JSON.stringify(window.mergedJsonConfig, null, 2);
                navigator.clipboard.writeText(jsonString).then(() => {
                    showError('合并后的JSON已复制到剪贴板！');
                }).catch(err => {
                    showError('复制失败: ' + err);
                });
            }

            // 下载合并后的JSON
            function downloadMergedJson() {
                if (!window.mergedJsonConfig) {
                    showError('请先合并JSON配置');
                    return;
                }
                
                const jsonString = JSON.stringify(window.mergedJsonConfig, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'merged_config.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // 加载指导内容 (prompt, example, explanation)
            async function loadGuideContent(stepName, type) {
                try {
                    const response = await fetch(`/get_guide_content/${stepName}/${type}`);
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        return data.content;
                    } else {
                        throw new Error(data.detail || '加载内容失败');
                    }
                } catch (error) {
                    console.error(`加载 ${stepName} ${type} 失败:`, error);
                    return `加载失败: ${error.message}`;
                }
            }

            // 加载组合指导内容
            async function loadCombinedGuideContent(stepName) {
                try {
                    const response = await fetch(`/get_combined_guide_content/${stepName}`);
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        return data.combined_prompt;
                    } else {
                        throw new Error(data.detail || '加载组合提示词失败');
                    }
                } catch (error) {
                    console.error(`加载 ${stepName} 组合提示词失败:`, error);
                    return `加载失败: ${error.message}`;
                }
            }

            // 初始化所有提示词和说明
            async function initAllGuideContent() {
                // Step 1
                document.getElementById('step1-prompt').value = await loadGuideContent('step1', 'prompt');
                document.getElementById('step1-example').value = await loadGuideContent('step1', 'example');
                // 组合提示词内容不再直接显示，只通过按钮复制
                
                // Step 2
                document.getElementById('step2-explanation').value = await loadGuideContent('step2', 'explanation');
                // 设置内容拆分工具的输入框placeholder
                document.getElementById('article-content').placeholder = "请在此输入需要拆分的长文章内容...";

                // Step 3
                document.getElementById('step3-prompt').value = await loadGuideContent('step3', 'prompt');
                document.getElementById('step3-example').value = await loadGuideContent('step3', 'example');
                // 组合提示词内容不再直接显示，只通过按钮复制

                // Step 4
                document.getElementById('step4-explanation').value = await loadGuideContent('step4', 'explanation');
                // Step 4 提示词和示例不再显示

                // Step 5
                document.getElementById('step5-explanation').value = await loadGuideContent('step5', 'explanation');

                // Step 6
                document.getElementById('step6-explanation').value = await loadGuideContent('step6', 'explanation');
            }

            // 页面加载完成后加载所有提示词
            document.addEventListener('DOMContentLoaded', () => {
                initAllGuideContent(); // 调用新的初始化函数
                initDragAndDrop();
                loadConfigList();
                initAutoUpload();
                initSliders();
                initConfigSelection();
                initVideoDeletion();
                initGlobalSettings();
            });
        </script>
    </div>
</body>
</html>